#!/bin/bash
# Public URL: http://ibm.biz/wfss-swinger-sshv
# Usage: bash <(curl -sSL http://ibm.biz/wfss-swinger-sshv)

VAULT_ADDR="http://vault:8200"
VAULT_TOKEN="s.ePQpZYy5DgApxWSpkoj9JLaD"

# Troubleshooting: Check your current login token
curl -sS --header "X-Vault-Token: $VAULT_TOKEN" --request GET $VAULT_ADDR/v1/auth/token/looku

# Create a temporary, i.e., worthless after its certificate expires, ssh keypair for this user
# Note that "echo yes | ... " overwrites any existing output file
echo yes | ssh-keygen -N '' -t ed25519 -a 100 -f ~/.ssh/id_ed25519_vault.pub

# Set parameters
tee foo.json <<EOF
{
  "public_key"       :  "$(cat ~/.ssh/id_ed25519_vault.pub | tr '\n' '*' | sed 's/\*/\\n/g')",
  "ttl"              :  "1m",
  "valid_principals" :  "user1",
  "cert_type"        :  "user",
  "key_id"           :  "user1@client1 created by sshv",
  "critical_options" :  {  },
  "extension"        :  { "permit-pty":"", "permit-port-forwarding": "" },
  "cert_type"        :  "user"
}
EOF

# Sign
curl -S --header "X-Vault-Token: $VAULT_TOKEN" --request POST --data @foo.json $VAULT_ADDR/v1/users-ca/sign/role1
